{% extends "base.html" %}

{% block title %}Dashboard - POCOPAN{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
            <h1 style="color: var(--naranja-primario); margin-bottom: 0.3rem; font-size: 1.5rem;">{{ stats.dashboard_nombre }}</h1>
            <p style="color: var(--texto-gris); font-size: 0.9rem;">
                ğŸ“Š EstadÃ­sticas en tiempo real â€¢ 
                <span id="fecha-actual" style="font-weight: 600;"></span>
            </p>
        </div>
        <div class="user-terminal">
            Actualizado: {{ now.strftime('%H:%M') if now else 'Ahora' }}
        </div>
    </div>

    <!-- Selector de Terminal (solo admin) -->
    {% if rol_actual == 'admin' %}
    <div class="card mb-2">
        <div class="card-body" style="padding: 0.8rem;">
            <h3 style="margin-bottom: 0.8rem; color: var(--naranja-primario); font-size: 1rem;">ğŸ” Seleccionar Terminal</h3>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="{{ url_for('dashboard_terminal', terminal_id='TODAS') }}" 
                   class="btn {% if terminal_actual == 'TODAS' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 6px 12px; font-size: 0.8rem;">
                    ğŸ“Š Todas las Terminales
                </a>
                <a href="{{ url_for('dashboard_terminal', terminal_id='POS1') }}" 
                   class="btn {% if terminal_actual == 'POS1' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 6px 12px; font-size: 0.8rem;">
                    ğŸª POS 1
                </a>
                <a href="{{ url_for('dashboard_terminal', terminal_id='POS2') }}" 
                   class="btn {% if terminal_actual == 'POS2' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 6px 12px; font-size: 0.8rem;">
                    ğŸª POS 2
                </a>
                <a href="{{ url_for('dashboard_terminal', terminal_id='POS3') }}" 
                   class="btn {% if terminal_actual == 'POS3' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 6px 12px; font-size: 0.8rem;">
                    ğŸª POS 3
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- EstadÃ­sticas Principales -->
    <div class="grid grid-4 mb-2">
        <div class="card">
            <div class="card-header" style="background: var(--naranja-primario); padding: 0.8rem;">
                ğŸ·ï¸ Ventas Totales
            </div>
            <div class="card-body" style="text-align: center; padding: 1rem 0.5rem;">
                <h2 style="font-size: 1.8rem; color: var(--naranja-primario); margin: 0; line-height: 1;">{{ stats.ventas_totales }}</h2>
                <p style="color: var(--texto-gris); margin: 0.3rem 0 0 0; font-size: 0.8rem;">Transacciones</p>
                <div style="margin-top: 0.5rem; padding: 0.4rem; background: var(--naranja-fondo); border-radius: 4px;">
                    <small style="color: var(--naranja-oscuro); font-size: 0.75rem;">Hoy: {{ stats.ventas_hoy_count }}</small>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="background: #28a745; padding: 0.8rem;">
                ğŸ’° Ingresos Totales
            </div>
            <div class="card-body" style="text-align: center; padding: 1rem 0.5rem;">
                <h2 style="font-size: 1.4rem; color: #28a745; margin: 0; line-height: 1.2;">{{ stats.ingresos_totales }}</h2>
                <p style="color: var(--texto-gris); margin: 0.3rem 0 0 0; font-size: 0.8rem;">Acumulado</p>
                <div style="margin-top: 0.5rem; padding: 0.4rem; background: #f0fff4; border-radius: 4px;">
                    <small style="color: #28a745; font-size: 0.75rem;" id="ingresos-hoy">Hoy: $0.00</small>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="background: #17a2b8; padding: 0.8rem;">
                ğŸ“¦ Productos
            </div>
            <div class="card-body" style="text-align: center; padding: 1rem 0.5rem;">
                <h2 style="font-size: 1.8rem; color: #17a2b8; margin: 0; line-height: 1;">{{ stats.productos_catalogo }}</h2>
                <p style="color: var(--texto-gris); margin: 0.3rem 0 0 0; font-size: 0.8rem;">En catÃ¡logo</p>
                <div style="margin-top: 0.5rem; padding: 0.4rem; background: #f0fdff; border-radius: 4px;">
                    <small style="color: #17a2b8; font-size: 0.75rem;" id="productos-vendidos-hoy">Vendidos hoy: 0</small>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="background: #6f42c1; padding: 0.8rem;">
                ğŸ“ˆ Promedio/DÃ­a
            </div>
            <div class="card-body" style="text-align: center; padding: 1rem 0.5rem;">
                <h2 style="font-size: 1.4rem; color: #6f42c1; margin: 0; line-height: 1.2;" id="promedio-diario">$0.00</h2>
                <p style="color: var(--texto-gris); margin: 0.3rem 0 0 0; font-size: 0.8rem;">Ingreso promedio</p>
                <div style="margin-top: 0.5rem; padding: 0.4rem; background: #f8f5ff; border-radius: 4px;">
                    <small style="color: #6f42c1; font-size: 0.75rem;" id="ventas-promedio-dia">0 ventas/dÃ­a</small>
                </div>
            </div>
        </div>
    </div>

    <!-- GrÃ¡ficos y EstadÃ­sticas Avanzadas -->
    <div class="grid grid-2 mb-2">
        <!-- Productos MÃ¡s Vendidos -->
        <div class="card">
            <div class="card-header">
                ğŸ† Productos MÃ¡s Vendidos
            </div>
            <div class="card-body">
                <div id="grafico-productos" style="min-height: 200px;">
                    <div style="text-align: center; padding: 2rem; color: var(--texto-gris);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“Š</div>
                        <p>Cargando estadÃ­sticas de productos...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- DistribuciÃ³n por CategorÃ­as -->
        <div class="card">
            <div class="card-header">
                ğŸ“‚ Ventas por CategorÃ­a
            </div>
            <div class="card-body">
                <div id="grafico-categorias" style="min-height: 200px;">
                    <div style="text-align: center; padding: 2rem; color: var(--texto-gris);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“ˆ</div>
                        <p>Cargando distribuciÃ³n por categorÃ­as...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ãšltimas Transacciones -->
    <div class="card mb-2">
        <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>ğŸ“‹ Ãšltimas Transacciones</span>
                <span class="user-terminal" id="total-transacciones">0 transacciones</span>
            </div>
        </div>
        <div class="card-body">
            <div id="lista-transacciones" class="scroll-container" style="max-height: 400px;">
                <div style="text-align: center; padding: 2rem; color: var(--texto-gris);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ”„</div>
                    <p>Cargando transacciones...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- EstadÃ­sticas por Hora -->
    <div class="card">
        <div class="card-header">
            ğŸ•’ Actividad por Hora del DÃ­a
        </div>
        <div class="card-body">
            <div id="grafico-horas" style="min-height: 200px;">
                <div style="text-align: center; padding: 2rem; color: var(--texto-gris);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">â°</div>
                    <p>Cargando actividad horaria...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ComparaciÃ³n de Terminales (solo admin) -->
    {% if rol_actual == 'admin' and stats_por_terminal %}
    <div class="card mt-2">
        <div class="card-header">
            ğŸ“ˆ ComparaciÃ³n entre Terminales
        </div>
        <div class="card-body">
            <div class="grid grid-3">
                {% for terminal, terminal_stats in stats_por_terminal.items() %}
                <div class="card">
                    <div class="card-header" style="background: var(--naranja-claro); padding: 0.8rem;">
                        ğŸª {{ terminal }}
                    </div>
                    <div class="card-body" style="padding: 0.8rem;">
                        <div style="text-align: center; margin-bottom: 0.8rem;">
                            <h3 style="color: var(--naranja-primario); font-size: 1.2rem; margin: 0;">{{ terminal_stats.ventas_totales }}</h3>
                            <p style="color: var(--texto-gris); margin: 0.2rem 0 0 0; font-size: 0.75rem;">Ventas Totales</p>
                        </div>
                        <div style="background: var(--naranja-fondo); padding: 0.6rem; border-radius: 6px; font-size: 0.8rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span>Ingresos:</span>
                                <strong>{{ terminal_stats.ingresos_totales }}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Ventas Hoy:</span>
                                <strong>{{ terminal_stats.ventas_hoy_count }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Actualizar fecha actual
    document.getElementById('fecha-actual').textContent = new Date().toLocaleDateString('es-ES', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });

    // Cargar estadÃ­sticas avanzadas
    function cargarEstadisticasAvanzadas() {
        fetch('/estadisticas-avanzadas?terminal={{ terminal_actual }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actualizarDashboard(data.estadisticas);
                    renderizarGraficos(data.estadisticas);
                    renderizarTransacciones(data.transacciones);
                }
            })
            .catch(error => {
                console.error('Error cargando estadÃ­sticas:', error);
            });
    }

    function actualizarDashboard(estadisticas) {
        // Actualizar ingresos de hoy
        document.getElementById('ingresos-hoy').textContent = `Hoy: $${estadisticas.ingresos_hoy.toFixed(2)}`;
        
        // Actualizar productos vendidos hoy
        document.getElementById('productos-vendidos-hoy').textContent = `Vendidos hoy: ${estadisticas.productos_vendidos_hoy}`;
        
        // Actualizar promedios
        document.getElementById('promedio-diario').textContent = `$${estadisticas.promedio_ingresos_diarios.toFixed(2)}`;
        document.getElementById('ventas-promedio-dia').textContent = `${estadisticas.promedio_ventas_diarias.toFixed(1)} ventas/dÃ­a`;
        
        // Actualizar total de transacciones
        document.getElementById('total-transacciones').textContent = `${estadisticas.total_transacciones} transacciones`;
    }

    function renderizarGraficos(estadisticas) {
        // GrÃ¡fico de productos mÃ¡s vendidos
        const ctxProductos = document.createElement('canvas');
        document.getElementById('grafico-productos').innerHTML = '';
        document.getElementById('grafico-productos').appendChild(ctxProductos);
        
        new Chart(ctxProductos, {
            type: 'bar',
            data: {
                labels: estadisticas.productos_mas_vendidos.map(p => p.producto),
                datasets: [{
                    label: 'Unidades Vendidas',
                    data: estadisticas.productos_mas_vendidos.map(p => p.cantidad),
                    backgroundColor: '#FF6B35',
                    borderColor: '#E55A2B',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: 'Top 5 Productos MÃ¡s Vendidos'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // GrÃ¡fico de categorÃ­as
        const ctxCategorias = document.createElement('canvas');
        document.getElementById('grafico-categorias').innerHTML = '';
        document.getElementById('grafico-categorias').appendChild(ctxCategorias);
        
        new Chart(ctxCategorias, {
            type: 'doughnut',
            data: {
                labels: estadisticas.ventas_por_categoria.map(c => c.categoria),
                datasets: [{
                    data: estadisticas.ventas_por_categoria.map(c => c.ventas),
                    backgroundColor: [
                        '#FF6B35', '#28a745', '#17a2b8', '#6f42c1', '#ffc107',
                        '#dc3545', '#20c997', '#fd7e14', '#e83e8c', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'DistribuciÃ³n por CategorÃ­as'
                    }
                }
            }
        });

        // GrÃ¡fico de actividad por hora
        const ctxHoras = document.createElement('canvas');
        document.getElementById('grafico-horas').innerHTML = '';
        document.getElementById('grafico-horas').appendChild(ctxHoras);
        
        new Chart(ctxHoras, {
            type: 'line',
            data: {
                labels: estadisticas.actividad_horaria.map(h => h.hora),
                datasets: [{
                    label: 'Ventas por Hora',
                    data: estadisticas.actividad_horaria.map(h => h.ventas),
                    borderColor: '#FF6B35',
                    backgroundColor: 'rgba(255, 107, 53, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Actividad de Ventas por Hora'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function renderizarTransacciones(transacciones) {
        const container = document.getElementById('lista-transacciones');
        
        if (transacciones.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--texto-gris);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“</div>
                    <p>No hay transacciones registradas</p>
                </div>
            `;
            return;
        }

        let html = '';
        transacciones.forEach(transaccion => {
            const fecha = new Date(transaccion.fecha + 'T' + transaccion.hora);
            const fechaFormateada = fecha.toLocaleDateString('es-ES');
            const horaFormateada = fecha.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            html += `
                <div style="border: 1px solid var(--naranja-borde); border-radius: 6px; padding: 0.8rem; margin-bottom: 0.6rem; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.4rem;">
                        <div style="flex: 1;">
                            <h4 style="color: var(--texto-oscuro); margin: 0 0 0.2rem 0; font-size: 0.9rem;">
                                ${transaccion.producto}
                            </h4>
                            <div style="display: flex; gap: 0.8rem; font-size: 0.75rem; color: var(--texto-gris);">
                                <span><strong>Cliente:</strong> ${transaccion.id_cliente}</span>
                                <span><strong>Terminal:</strong> ${transaccion.id_terminal}</span>
                            </div>
                        </div>
                        <div style="text-align: right; min-width: 100px;">
                            <div style="font-size: 1rem; font-weight: bold; color: #28a745;">
                                $${transaccion.total_venta.toFixed(2)}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--texto-gris);">
                                ${fechaFormateada} ${horaFormateada}
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; font-size: 0.75rem;">
                        <div><strong>Cantidad:</strong> ${transaccion.cantidad}</div>
                        <div><strong>Precio Unit:</strong> $${transaccion.precio_unitario.toFixed(2)}</div>
                        <div><strong>Vendedor:</strong> ${transaccion.vendedor}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // Cargar estadÃ­sticas al iniciar
    document.addEventListener('DOMContentLoaded', function() {
        cargarEstadisticasAvanzadas();
        
        // Actualizar cada 30 segundos
        setInterval(cargarEstadisticasAvanzadas, 30000);
    });
</script>
{% endblock %}
