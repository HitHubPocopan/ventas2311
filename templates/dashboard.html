{% extends "base.html" %}

{% block title %}Dashboard - POCOPAN{% endblock %}

{% block page_title %}Dashboard Analytics{% endblock %}
{% block page_subtitle %}Estad√≠sticas en tiempo real ‚Ä¢ {{ stats.dashboard_nombre }}{% endblock %}

{% block content %}
<div class="fade-in" style="height: 100%;">
    <!-- Acciones R√°pidas -->
    <div class="card mb-3">
        <div class="card-header" style="background: #3498db; color: white;">
            üöÄ Acciones R√°pidas
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                <button onclick="cargarEstadisticasAvanzadas()" class="btn btn-primary">
                    üîÑ Actualizar Datos
                </button>
                <button onclick="descargarExcel()" class="btn btn-success">
                    üìä Descargar Excel de Ventas
                </button>
                {% if rol_actual == 'admin' %}
                <a href="{{ url_for('editor_catalogo') }}" class="btn btn-outline">
                    üì¶ Editor de Cat√°logo
                </a>
                {% endif %}
                <span style="color: #7f8c8d; font-size: 0.9rem; margin-left: auto;">
                    Actualizado: {{ now.strftime('%H:%M') }}
                </span>
            </div>
        </div>
    </div>

    <!-- Selector de Terminal (solo admin) -->
    {% if rol_actual == 'admin' %}
    <div class="card mb-3">
        <div class="card-header">
            üîç Seleccionar Terminal
        </div>
        <div class="card-body" style="padding: 1.2rem;">
            <div style="display: flex; gap: 0.8rem; flex-wrap: wrap;">
                <a href="{{ url_for('dashboard_terminal', terminal_id='TODAS') }}" 
                   class="btn {% if terminal_actual == 'TODAS' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 0.8rem 1.2rem; font-size: 0.9rem;">
                    üìä Todas las Terminales
                </a>
                <a href="{{ url_for('dashboard_terminal', terminal_id='POS1') }}" 
                   class="btn {% if terminal_actual == 'POS1' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 0.8rem 1.2rem; font-size: 0.9rem;">
                    üè™ POS 1
                </a>
                <a href="{{ url_for('dashboard_terminal', terminal_id='POS2') }}" 
                   class="btn {% if terminal_actual == 'POS2' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 0.8rem 1.2rem; font-size: 0.9rem;">
                    üè™ POS 2
                </a>
                <a href="{{ url_for('dashboard_terminal', terminal_id='POS3') }}" 
                   class="btn {% if terminal_actual == 'POS3' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 0.8rem 1.2rem; font-size: 0.9rem;">
                    üè™ POS 3
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Estad√≠sticas Principales -->
    <div class="grid grid-4 mb-3">
        <!-- Ventas Totales -->
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 1rem;">
                üè∑Ô∏è Ventas Totales
            </div>
            <div class="card-body" style="text-align: center; padding: 1.5rem 1rem;">
                <h2 style="font-size: 2.5rem; color: #2c3e50; margin: 0 0 0.5rem 0; line-height: 1; font-weight: 700;">
                    {{ stats.ventas_totales }}
                </h2>
                <p style="color: #7f8c8d; margin: 0; font-size: 0.9rem; font-weight: 500;">Transacciones</p>
                <div style="margin-top: 1rem; padding: 0.8rem; background: #f8f9fa; border-radius: 8px;">
                    <small style="color: #27ae60; font-size: 0.85rem; font-weight: 600;">
                        Hoy: {{ stats.ventas_hoy_count }}
                    </small>
                </div>
            </div>
        </div>

        <!-- Ingresos Totales -->
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; text-align: center; padding: 1rem;">
                üí∞ Ingresos Totales
            </div>
            <div class="card-body" style="text-align: center; padding: 1.5rem 1rem;">
                <h2 style="font-size: 1.8rem; color: #2c3e50; margin: 0 0 0.5rem 0; line-height: 1.2; font-weight: 700;">
                    {{ stats.ingresos_totales }}
                </h2>
                <p style="color: #7f8c8d; margin: 0; font-size: 0.9rem; font-weight: 500;">Acumulado</p>
                <div style="margin-top: 1rem; padding: 0.8rem; background: #fff5f5; border-radius: 8px;">
                    <small style="color: #e74c3c; font-size: 0.85rem; font-weight: 600;" id="ingresos-hoy">
                        Hoy: $0.00
                    </small>
                </div>
            </div>
        </div>

        <!-- Productos -->
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; text-align: center; padding: 1rem;">
                üì¶ Productos
            </div>
            <div class="card-body" style="text-align: center; padding: 1.5rem 1rem;">
                <h2 style="font-size: 2.5rem; color: #2c3e50; margin: 0 0 0.5rem 0; line-height: 1; font-weight: 700;">
                    {{ stats.productos_catalogo }}
                </h2>
                <p style="color: #7f8c8d; margin: 0; font-size: 0.9rem; font-weight: 500;">En cat√°logo</p>
                <div style="margin-top: 1rem; padding: 0.8rem; background: #f0fdff; border-radius: 8px;">
                    <small style="color: #3498db; font-size: 0.85rem; font-weight: 600;" id="productos-vendidos-hoy">
                        Vendidos hoy: 0
                    </small>
                </div>
            </div>
        </div>

        <!-- Monto Hist√≥rico -->
        <div class="card">
            <div class="card-header" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; text-align: center; padding: 1rem;">
                üìà Monto Hist√≥rico
            </div>
            <div class="card-body" style="text-align: center; padding: 1.5rem 1rem;">
                <h2 style="font-size: 1.8rem; color: #2c3e50; margin: 0 0 0.5rem 0; line-height: 1.2; font-weight: 700;" id="monto-historico">
                    $0.00
                </h2>
                <p style="color: #7f8c8d; margin: 0; font-size: 0.9rem; font-weight: 500;">Total hist√≥rico</p>
                <div style="margin-top: 1rem; padding: 0.8rem; background: #f8f5ff; border-radius: 8px;">
                    <small style="color: #9b59b6; font-size: 0.85rem; font-weight: 600;" id="promedio-diario">
                        Promedio: $0.00/d√≠a
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n Inferior - 2 Columnas -->
    <div class="grid grid-2 gap-3" style="height: 400px;">
        <!-- Columna Izquierda: Transacciones -->
        <div class="card" style="display: flex; flex-direction: column;">
            <div class="card-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>üìã Transacciones del D√≠a</span>
                    <span style="background: #3498db; color: white; padding: 0.4rem 0.8rem; border-radius: 15px; font-size: 0.8rem; font-weight: 600;"
                          id="total-transacciones-hoy">Hoy: 0</span>
                </div>
            </div>
            <div class="card-body" style="flex: 1; display: flex; flex-direction: column; padding: 0;">
                <!-- Resumen -->
                <div style="padding: 1.2rem; border-bottom: 1px solid #e9ecef; background: #f8f9fa;">
                    <div style="text-align: center;">
                        <div style="display: inline-block; background: white; padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 1.5rem; font-weight: 700; color: #3498db;" id="transacciones-hoy-count">
                                0
                            </div>
                            <div style="font-size: 0.85rem; color: #7f8c8d; font-weight: 500;">Transacciones de Hoy</div>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de Transacciones -->
                <div id="lista-transacciones-hoy" style="flex: 1; overflow-y: auto; padding: 1.2rem;">
                    <div style="text-align: center; padding: 2rem 1rem; color: #bdc3c7;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                        <p style="font-weight: 500; margin-bottom: 0.5rem;">No hay transacciones hoy</p>
                        <p style="font-size: 0.9rem;">Las ventas de hoy aparecer√°n aqu√≠</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Columna Derecha: Productos M√°s Vendidos -->
        <div class="card" style="display: flex; flex-direction: column;">
            <div class="card-header">
                üèÜ Productos M√°s Vendidos (Hoy)
            </div>
            <div class="card-body" style="flex: 1; display: flex; flex-direction: column; padding: 0;">
                <div id="lista-productos-vendidos" style="flex: 1; overflow-y: auto; padding: 1.2rem;">
                    <div style="text-align: center; padding: 2rem 1rem; color: #bdc3c7;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                        <p style="font-weight: 500; margin-bottom: 0.5rem;">No hay productos vendidos hoy</p>
                        <p style="font-size: 0.9rem;">Los productos m√°s vendidos aparecer√°n aqu√≠</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparaci√≥n de Terminales (solo admin) -->
    {% if rol_actual == 'admin' and stats_por_terminal %}
    <div class="card mt-3">
        <div class="card-header">
            üìà Comparaci√≥n entre Terminales
        </div>
        <div class="card-body">
            <div class="grid grid-3">
                {% for terminal, terminal_stats in stats_por_terminal.items() %}
                <div class="card">
                    <div class="card-header" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); text-align: center; padding: 1rem;">
                        <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üè™</div>
                        <strong style="color: #2c3e50;">{{ terminal }}</strong>
                    </div>
                    <div class="card-body" style="padding: 1.2rem;">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <h3 style="color: #e74c3c; font-size: 1.8rem; margin: 0 0 0.5rem 0; font-weight: 700;">
                                {{ terminal_stats.ventas_totales }}
                            </h3>
                            <p style="color: #7f8c8d; margin: 0; font-size: 0.85rem; font-weight: 500;">Ventas Totales</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-size: 0.85rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.6rem; padding-bottom: 0.4rem; border-bottom: 1px solid #e9ecef;">
                                <span style="color: #7f8c8d;">Ingresos:</span>
                                <strong style="color: #27ae60;">{{ terminal_stats.ingresos_totales }}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span style="color: #7f8c8d;">Ventas Hoy:</span>
                                <strong style="color: #3498db;">{{ terminal_stats.ventas_hoy_count }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Actualizar fecha actual
    document.getElementById('fecha-actual').textContent = new Date().toLocaleDateString('es-ES', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });

    // Cargar estad√≠sticas avanzadas
    function cargarEstadisticasAvanzadas() {
        showNotification('üîÑ Actualizando datos...', 'info');
        
        fetch('/estadisticas-avanzadas?terminal={{ terminal_actual }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    actualizarDashboard(data.estadisticas);
                    renderizarTransaccionesHoy(data.transacciones_hoy);
                    renderizarProductosVendidos(data.productos_mas_vendidos);
                    showNotification('‚úÖ Datos actualizados correctamente', 'success');
                } else {
                    showNotification('‚ùå Error al cargar los datos', 'error');
                }
            })
            .catch(error => {
                console.error('Error cargando estad√≠sticas:', error);
                showNotification('‚ùå Error de conexi√≥n con el servidor', 'error');
            });
    }

    function actualizarDashboard(estadisticas) {
        // Actualizar ingresos de hoy
        if (document.getElementById('ingresos-hoy')) {
            document.getElementById('ingresos-hoy').textContent = `Hoy: $${estadisticas.ingresos_hoy.toFixed(2)}`;
        }
        
        // Actualizar productos vendidos hoy
        if (document.getElementById('productos-vendidos-hoy')) {
            document.getElementById('productos-vendidos-hoy').textContent = `Vendidos hoy: ${estadisticas.productos_vendidos_hoy}`;
        }
        
        // Actualizar monto hist√≥rico
        if (document.getElementById('monto-historico')) {
            document.getElementById('monto-historico').textContent = `$${estadisticas.monto_historico.toFixed(2)}`;
        }
        if (document.getElementById('promedio-diario')) {
            document.getElementById('promedio-diario').textContent = `Promedio: $${estadisticas.promedio_diario.toFixed(2)}/d√≠a`;
        }
        
        // Actualizar total de transacciones hoy
        if (document.getElementById('total-transacciones-hoy')) {
            document.getElementById('total-transacciones-hoy').textContent = `Hoy: ${estadisticas.transacciones_hoy_count}`;
        }
        if (document.getElementById('transacciones-hoy-count')) {
            document.getElementById('transacciones-hoy-count').textContent = estadisticas.transacciones_hoy_count;
        }
    }

    function renderizarTransaccionesHoy(transacciones) {
        const container = document.getElementById('lista-transacciones-hoy');
        if (!container) return;
        
        if (transacciones.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem 1rem; color: #bdc3c7;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                    <p style="font-weight: 500; margin-bottom: 0.5rem;">No hay transacciones hoy</p>
                    <p style="font-size: 0.9rem;">Las ventas de hoy aparecer√°n aqu√≠</p>
                </div>
            `;
            return;
        }

        let html = '';
        transacciones.forEach(transaccion => {
            const fecha = new Date(transaccion.Fecha + 'T' + transaccion.Hora);
            const horaFormateada = fecha.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            html += `
                <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 0.8rem; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.6rem;">
                        <div style="flex: 1;">
                            <h4 style="color: #2c3e50; margin: 0 0 0.3rem 0; font-size: 0.95rem; font-weight: 600;">
                                ${transaccion.Producto}
                            </h4>
                            <div style="display: flex; gap: 1rem; font-size: 0.8rem; color: #7f8c8d;">
                                <span><strong>Cliente:</strong> ${transaccion.ID_Cliente}</span>
                                <span><strong>Hora:</strong> ${horaFormateada}</span>
                            </div>
                        </div>
                        <div style="text-align: right; min-width: 100px;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: #27ae60; margin-bottom: 0.3rem;">
                                $${transaccion.Total_Venta.toFixed(2)}
                            </div>
                            <div style="font-size: 0.75rem; color: #7f8c8d; background: #f8f9fa; padding: 0.2rem 0.5rem; border-radius: 12px;">
                                Cant: ${transaccion.Cantidad}
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.8rem; font-size: 0.75rem; padding-top: 0.6rem; border-top: 1px solid #f1f1f1;">
                        <div><strong>Precio Unit:</strong> $${transaccion.Precio_Unitario.toFixed(2)}</div>
                        <div><strong>Vendedor:</strong> ${transaccion.Vendedor}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function renderizarProductosVendidos(productos) {
        const container = document.getElementById('lista-productos-vendidos');
        if (!container) return;
        
        if (productos.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem 1rem; color: #bdc3c7;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üì¶</div>
                    <p style="font-weight: 500; margin-bottom: 0.5rem;">No hay productos vendidos hoy</p>
                    <p style="font-size: 0.9rem;">Los productos m√°s vendidos aparecer√°n aqu√≠</p>
                </div>
            `;
            return;
        }

        let html = '<div style="display: grid; gap: 0.8rem;">';
        productos.forEach((producto, index) => {
            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57'];
            const color = colors[index] || '#bdc3c7';
            
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: white; border: 1px solid #e9ecef; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">${medal}</span>
                        <div>
                            <div style="font-size: 0.95rem; font-weight: 600; color: #2c3e50; margin-bottom: 0.2rem;">
                                ${producto.producto}
                            </div>
                            <div style="font-size: 0.8rem; color: #7f8c8d;">
                                ${producto.cantidad} unidades vendidas
                            </div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.9rem; font-weight: 700; color: ${color}; background: ${color}20; padding: 0.4rem 0.8rem; border-radius: 15px;">
                            #${index + 1}
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    function descargarExcel() {
        showNotification('üìä Generando archivo Excel...', 'info');
        
        fetch('/descargar-excel?terminal={{ terminal_actual }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al generar el archivo');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `ventas_pocopan_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showNotification('‚úÖ Excel descargado correctamente', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('‚ùå Error al descargar el archivo Excel', 'error');
            });
    }

    // Cargar estad√≠sticas al iniciar
    document.addEventListener('DOMContentLoaded', function() {
        cargarEstadisticasAvanzadas();
        
        // Actualizar autom√°ticamente cada 30 segundos
        setInterval(cargarEstadisticasAvanzadas, 30000);
        
        // Agregar evento para recargar con F5
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F5') {
                e.preventDefault();
                cargarEstadisticasAvanzadas();
            }
        });
    });

    // Funci√≥n global para confirmaciones
    function confirmAction(message) {
        return confirm(message);
    }
</script>
{% endblock %}