<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - POCOPAN</title>
    <style>
        :root {
            --naranja-primario: #FF6B00;
            --naranja-oscuro: #E55A00;
            --naranja-claro: #FF8C42;
            --naranja-fondo: #FFF5EB;
            --naranja-borde: #FFD4B8;
            --texto-oscuro: #333333;
            --texto-gris: #666666;
            --fondo-gris: #F5F5F5;
            --borde-gris: #E0E0E0;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--fondo-gris);
            color: var(--texto-oscuro);
            padding: 1rem;
            line-height: 1.5;
        }
        
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* Header unificado */
        .header-unificado {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--naranja-primario);
        }
        
        .header-info h1 {
            color: var(--naranja-primario);
            margin-bottom: 0.3rem;
            font-size: 1.5rem;
        }
        
        .header-info p {
            color: var(--texto-gris);
            font-size: 0.9rem;
        }
        
        .header-terminal {
            background: var(--naranja-fondo);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--naranja-oscuro);
            font-weight: 500;
        }
        
        .badge-rol {
            background: var(--naranja-primario);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        /* Bot√≥n volver */
        .btn-volver {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--naranja-primario);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background 0.2s;
            margin-bottom: 1rem;
        }
        
        .btn-volver:hover {
            background: var(--naranja-oscuro);
        }
        
        /* Tarjetas y layout */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .card-header {
            padding: 0.8rem 1rem;
            font-weight: 600;
            border-bottom: 1px solid var(--borde-gris);
        }
        
        .card-body {
            padding: 1rem;
        }
        
        .grid {
            display: grid;
            gap: 1rem;
        }
        
        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        /* Botones */
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--naranja-primario);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--naranja-oscuro);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-outline {
            background: transparent;
            border: 1px solid var(--naranja-primario);
            color: var(--naranja-primario);
        }
        
        .btn-outline:hover {
            background: var(--naranja-fondo);
        }
        
        /* √Åreas con scroll */
        .scroll-area {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        .scroll-area::-webkit-scrollbar {
            width: 6px;
        }
        
        .scroll-area::-webkit-scrollbar-track {
            background: var(--fondo-gris);
            border-radius: 3px;
        }
        
        .scroll-area::-webkit-scrollbar-thumb {
            background: var(--naranja-borde);
            border-radius: 3px;
        }
        
        .scroll-area::-webkit-scrollbar-thumb:hover {
            background: var(--naranja-claro);
        }
        
        /* Estados de carga */
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--texto-gris);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 107, 0, 0.3);
            border-radius: 50%;
            border-top-color: var(--naranja-primario);
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Indicador de terminal en transacciones */
        .terminal-indicator {
            background: var(--naranja-fondo);
            color: var(--naranja-oscuro);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        /* Vista unificada para admin */
        .vista-unificada {
            border-left: 4px solid var(--naranja-primario);
            background: var(--naranja-fondo);
        }
        
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .notification.info {
            background: #17a2b8;
        }
        
        .notification.success {
            background: #28a745;
        }
        
        .notification.error {
            background: #dc3545;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .grid-4, .grid-3 {
                grid-template-columns: 1fr 1fr;
            }
            
            .header-unificado {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .grid-4, .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Bot√≥n para volver al punto de venta -->
        <a href="/punto-venta" class="btn-volver">
            ‚Üê Volver al Punto de Venta
        </a>

        <!-- Header unificado -->
        <div class="header-unificado">
            <div class="header-info">
                <h1>POCOPAN</h1>
                <p>
                    Punto de Venta - Dashboard 
                    <span id="terminal-info">- Terminal: POS1</span>
                    <span class="badge-rol" id="rol-usuario">Usuario</span>
                </p>
            </div>
            <div class="header-terminal">
                Actualizado: <span id="hora-actualizada">10:00</span>
            </div>
        </div>

        <!-- Informaci√≥n del dashboard -->
        <div class="card" id="card-info-dashboard">
            <div class="card-header">
                <span id="titulo-dashboard">Dashboard - Terminal POS1</span>
            </div>
            <div class="card-body">
                <p>Estad√≠sticas en tiempo real ‚Ä¢ <span id="fecha-actual">martes, 25 de noviembre de 2025</span></p>
            </div>
        </div>

        <!-- Estad√≠sticas Principales -->
        <div class="grid grid-4 mb-2">
            <!-- Ventas Totales -->
            <div class="card">
                <div class="card-header" style="background: var(--naranja-primario); color: white; text-align: center; padding: 0.8rem;">
                    üè∑Ô∏è Ventas Totales
                </div>
                <div class="card-body" style="text-align: center; padding: 1.2rem 0.5rem;">
                    <h2 style="font-size: 2rem; color: var(--naranja-primario); margin: 0 0 0.5rem 0; line-height: 1;" id="ventas-totales">
                        <span class="loading-spinner"></span>Cargando...
                    </h2>
                    <p style="color: var(--texto-gris); margin: 0; font-size: 0.9rem;">Transacciones</p>
                    <div style="margin-top: 0.8rem; padding: 0.5rem; background: var(--naranja-fondo); border-radius: 6px;">
                        <small style="color: var(--naranja-oscuro); font-size: 0.8rem; font-weight: 600;" id="ventas-hoy">
                            Hoy: Cargando...
                        </small>
                    </div>
                </div>
            </div>

            <!-- Ingresos Totales -->
            <div class="card">
                <div class="card-header" style="background: #28a745; color: white; text-align: center; padding: 0.8rem;">
                    üí∞ Ingresos Totales
                </div>
                <div class="card-body" style="text-align: center; padding: 1.2rem 0.5rem;">
                    <h2 style="font-size: 1.5rem; color: #28a745; margin: 0 0 0.5rem 0; line-height: 1.2;" id="ingresos-totales">
                        <span class="loading-spinner"></span>Cargando...
                    </h2>
                    <p style="color: var(--texto-gris); margin: 0; font-size: 0.9rem;">Acumulado</p>
                    <div style="margin-top: 0.8rem; padding: 0.5rem; background: #f0fff4; border-radius: 6px;">
                        <small style="color: #28a745; font-size: 0.8rem; font-weight: 600;" id="ingresos-hoy">
                            Hoy: Cargando...
                        </small>
                    </div>
                </div>
            </div>

            <!-- Productos -->
            <div class="card">
                <div class="card-header" style="background: #17a2b8; color: white; text-align: center; padding: 0.8rem;">
                    üì¶ Productos
                </div>
                <div class="card-body" style="text-align: center; padding: 1.2rem 0.5rem;">
                    <h2 style="font-size: 2rem; color: #17a2b8; margin: 0 0 0.5rem 0; line-height: 1;" id="productos-catalogo">
                        <span class="loading-spinner"></span>Cargando...
                    </h2>
                    <p style="color: var(--texto-gris); margin: 0; font-size: 0.9rem;">En cat√°logo</p>
                    <div style="margin-top: 0.8rem; padding: 0.5rem; background: #f0fdff; border-radius: 6px;">
                        <small style="color: #17a2b8; font-size: 0.8rem; font-weight: 600;" id="productos-vendidos-hoy">
                            Vendidos hoy: Cargando...
                        </small>
                    </div>
                </div>
            </div>

            <!-- Monto Hist√≥rico -->
            <div class="card">
                <div class="card-header" style="background: #6f42c1; color: white; text-align: center; padding: 0.8rem;">
                    üìà Monto Hist√≥rico
                </div>
                <div class="card-body" style="text-align: center; padding: 1.2rem 0.5rem;">
                    <h2 style="font-size: 1.5rem; color: #6f42c1; margin: 0 0 0.5rem 0; line-height: 1.2;" id="monto-historico">
                        <span class="loading-spinner"></span>Cargando...
                    </h2>
                    <p style="color: var(--texto-gris); margin: 0; font-size: 0.9rem;">Total hist√≥rico</p>
                    <div style="margin-top: 0.8rem; padding: 0.5rem; background: #f8f5ff; border-radius: 6px;">
                        <small style="color: #6f42c1; font-size: 0.8rem; font-weight: 600;" id="promedio-diario">
                            Promedio: Cargando...
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vista unificada para ADMIN -->
        <div class="card mb-2" id="vista-unificada-admin" style="display: none;">
            <div class="card-header vista-unificada">
                üëë Vista de Administrador - Todas las Terminales Unificadas
            </div>
            <div class="card-body">
                <div class="grid grid-3" id="grid-terminales-admin">
                    <!-- Se llenar√° din√°micamente con datos de cada terminal -->
                </div>
            </div>
        </div>

        <!-- Secci√≥n Inferior - 2 Columnas -->
        <div class="main-layout">
            <!-- Columna Izquierda: Transacciones -->
            <div class="card" style="height: 100%;">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìã Transacciones <span id="subtitulo-transacciones"></span></span>
                        <span class="header-terminal" id="total-transacciones-hoy">Hoy: Cargando...</span>
                    </div>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 1rem; text-align: center;">
                        <div style="display: inline-block; background: var(--naranja-fondo); padding: 0.8rem 1.5rem; border-radius: 8px;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--naranja-primario);" id="transacciones-hoy-count">
                                <span class="loading-spinner"></span>Cargando...
                            </div>
                            <div style="font-size: 0.8rem; color: var(--texto-gris);">Transacciones de Hoy</div>
                        </div>
                    </div>

                    <!-- Lista de Transacciones con Scroll Interno -->
                    <div class="scroll-area">
                        <div id="lista-transacciones-hoy" class="loading">
                            <div class="loading-spinner"></span>Cargando transacciones...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha: Productos M√°s Vendidos -->
            <div class="card" style="height: 100%;">
                <div class="card-header">
                    üèÜ Productos M√°s Vendidos <span id="subtitulo-productos"></span>
                </div>
                <div class="card-body">
                    <!-- Lista de Productos con Scroll Interno -->
                    <div class="scroll-area">
                        <div id="lista-productos-vendidos" class="loading">
                            <div class="loading-spinner"></span>Cargando productos...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Acciones R√°pidas (al final) -->
        <div class="card mb-2">
            <div class="card-header" style="background: var(--naranja-primario); color: white;">
                üöÄ Actualizar Datos
            </div>
            <div class="card-body">
                <div style="display: flex; gap: 0.8rem; flex-wrap: wrap; align-items: center;">
                    <button onclick="cargarEstadisticasAvanzadas()" class="btn btn-primary">
                        üîÑ Actualizar Datos
                    </button>
                    <button onclick="descargarExcel()" class="btn btn-success">
                        üìä Descargar Excel de Ventas
                    </button>
                    <span style="color: var(--texto-gris); font-size: 0.8rem;">
                        Actualizado: <span id="hora-actualizacion">10:00</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Notificaciones -->
    <div id="notification" class="notification"></div>

    <script>
        // Configuraci√≥n del usuario actual
        // Cambia estos valores seg√∫n el usuario que est√© logueado
        const usuarioActual = {
            rol: 'admin', // 'admin' o 'pos'
            terminal: 'POS1' // Para usuarios POS: 'POS1', 'POS2', 'POS3'
        };

        // Actualizar fecha y hora actual
        function actualizarFechaHora() {
            const ahora = new Date();
            document.getElementById('fecha-actual').textContent = ahora.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const hora = ahora.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            document.getElementById('hora-actualizada').textContent = hora;
            document.getElementById('hora-actualizacion').textContent = hora;
        }
        
        // Configurar interfaz seg√∫n el rol
        function configurarInterfazPorRol() {
            const esAdmin = usuarioActual.rol === 'admin';
            
            // Actualizar badge de rol
            document.getElementById('rol-usuario').textContent = esAdmin ? 'Administrador' : 'Usuario POS';
            
            // Actualizar informaci√≥n de terminal
            if (esAdmin) {
                document.getElementById('terminal-info').textContent = '- Todas las Terminales';
                document.getElementById('subtitulo-transacciones').textContent = '(Todas las terminales)';
                document.getElementById('subtitulo-productos').textContent = '(Todas las terminales)';
                document.getElementById('titulo-dashboard').textContent = 'Dashboard - Todas las Terminales (Vista Unificada)';
                document.getElementById('card-info-dashboard').classList.add('vista-unificada');
            } else {
                document.getElementById('terminal-info').textContent = `- Terminal: ${usuarioActual.terminal}`;
                document.getElementById('subtitulo-transacciones').textContent = `(Terminal ${usuarioActual.terminal})`;
                document.getElementById('subtitulo-productos').textContent = `(Terminal ${usuarioActual.terminal})`;
                document.getElementById('titulo-dashboard').textContent = `Dashboard - Terminal ${usuarioActual.terminal}`;
                document.getElementById('card-info-dashboard').classList.remove('vista-unificada');
            }
        }
        
        // Mostrar notificaci√≥n
        function showNotification(mensaje, tipo) {
            const notification = document.getElementById('notification');
            notification.textContent = mensaje;
            notification.className = `notification ${tipo} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Cargar estad√≠sticas avanzadas - USANDO ENDPOINTS EXISTENTES
        function cargarEstadisticasAvanzadas() {
            showNotification('üîÑ Actualizando datos...', 'info');
            
            const esAdmin = usuarioActual.rol === 'admin';
            
            // Usar endpoints existentes en lugar de los que causan error 404
            if (esAdmin) {
                // Para admin: usar el endpoint que ya tienes para todas las terminales
                // Si no existe, usar√≠amos el endpoint individual para cada terminal y combinar los datos
                cargarDatosParaAdmin();
            } else {
                // Para usuarios POS: usar el endpoint que ya tienes para una terminal espec√≠fica
                cargarDatosParaPOS();
            }
        }
        
        // Cargar datos para usuarios POS (endpoint existente)
        function cargarDatosParaPOS() {
            // Usar el endpoint que ya tienes funcionando para una terminal espec√≠fica
            fetch(`/estadisticas-avanzadas?terminal=${usuarioActual.terminal}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        actualizarDashboard(data.estadisticas);
                        renderizarTransaccionesHoy(data.transacciones_hoy);
                        renderizarProductosVendidos(data.productos_mas_vendidos);
                        showNotification('‚úÖ Datos actualizados', 'success');
                    } else {
                        showNotification('‚ùå Error al cargar datos', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error cargando estad√≠sticas:', error);
                    // Si falla, cargar datos de ejemplo
                    cargarDatosEjemplo();
                    showNotification('‚ö†Ô∏è Usando datos de ejemplo', 'info');
                });
        }
        
        // Cargar datos para admin (combinando endpoints existentes)
        function cargarDatosParaAdmin() {
            // Intentar cargar datos unificados si el endpoint existe
            fetch('/estadisticas-avanzadas?terminal=TODAS')
                .then(response => {
                    if (!response.ok) {
                        // Si no existe, cargar datos de cada terminal por separado
                        throw new Error('Endpoint unificado no disponible');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        actualizarDashboard(data.estadisticas);
                        renderizarTransaccionesHoy(data.transacciones_hoy);
                        renderizarProductosVendidos(data.productos_mas_vendidos);
                        
                        // Si hay datos por terminal, mostrar la vista unificada
                        if (data.terminales) {
                            cargarVistaUnificadaAdmin(data.terminales);
                        }
                        
                        showNotification('‚úÖ Datos actualizados', 'success');
                    } else {
                        throw new Error('Datos no v√°lidos');
                    }
                })
                .catch(error => {
                    console.error('Error cargando datos unificados:', error);
                    // Si falla, cargar datos de cada terminal por separado
                    cargarDatosSeparadosPorTerminal();
                });
        }
        
        // Cargar datos por terminal separadamente (fallback para admin)
        function cargarDatosSeparadosPorTerminal() {
            const terminales = ['POS1', 'POS2', 'POS3'];
            let datosCombinados = {
                estadisticas: {
                    ventas_totales: 0,
                    ingresos_totales: 0,
                    productos_catalogo: 0,
                    monto_historico: 0,
                    promedio_diario: 0,
                    ventas_hoy_count: 0,
                    ingresos_hoy: 0,
                    productos_vendidos_hoy: 0,
                    transacciones_hoy_count: 0
                },
                transacciones_hoy: [],
                productos_mas_vendidos: [],
                terminales: {}
            };
            
            let terminalesCargadas = 0;
            
            terminales.forEach(terminal => {
                fetch(`/estadisticas-avanzadas?terminal=${terminal}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Error cargando ${terminal}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Combinar estad√≠sticas
                            datosCombinados.estadisticas.ventas_totales += parseInt(data.estadisticas.ventas_totales) || 0;
                            datosCombinados.estadisticas.ingresos_totales += parseFloat(data.estadisticas.ingresos_totales.replace(/[^0-9.-]+/g,"")) || 0;
                            datosCombinados.estadisticas.ventas_hoy_count += parseInt(data.estadisticas.ventas_hoy_count) || 0;
                            datosCombinados.estadisticas.ingresos_hoy += parseFloat(data.estadisticas.ingresos_hoy.replace(/[^0-9.-]+/g,"")) || 0;
                            datosCombinados.estadisticas.productos_vendidos_hoy += parseInt(data.estadisticas.productos_vendidos_hoy) || 0;
                            datosCombinados.estadisticas.transacciones_hoy_count += parseInt(data.estadisticas.transacciones_hoy_count) || 0;
                            
                            // Combinar transacciones
                            if (data.transacciones_hoy) {
                                datosCombinados.transacciones_hoy = datosCombinados.transacciones_hoy.concat(data.transacciones_hoy);
                            }
                            
                            // Combinar productos
                            if (data.productos_mas_vendidos) {
                                datosCombinados.productos_mas_vendidos = datosCombinados.productos_mas_vendidos.concat(data.productos_mas_vendidos);
                            }
                            
                            // Guardar datos por terminal
                            datosCombinados.terminales[terminal] = data.estadisticas;
                        }
                        
                        terminalesCargadas++;
                        
                        // Cuando todas las terminales est√©n cargadas
                        if (terminalesCargadas === terminales.length) {
                            // Formatear ingresos
                            datosCombinados.estadisticas.ingresos_totales = `$${datosCombinados.estadisticas.ingresos_totales.toFixed(2)}`;
                            datosCombinados.estadisticas.ingresos_hoy = `$${datosCombinados.estadisticas.ingresos_hoy.toFixed(2)}`;
                            
                            // Actualizar la interfaz
                            actualizarDashboard(datosCombinados.estadisticas);
                            renderizarTransaccionesHoy(datosCombinados.transacciones_hoy);
                            renderizarProductosVendidos(datosCombinados.productos_mas_vendidos);
                            cargarVistaUnificadaAdmin(datosCombinados.terminales);
                            
                            showNotification('‚úÖ Datos combinados cargados', 'success');
                        }
                    })
                    .catch(error => {
                        console.error(`Error cargando ${terminal}:`, error);
                        terminalesCargadas++;
                        
                        // Si fallan todas, cargar datos de ejemplo
                        if (terminalesCargadas === terminales.length && datosCombinados.transacciones_hoy.length === 0) {
                            cargarDatosEjemplo();
                            showNotification('‚ö†Ô∏è Usando datos de ejemplo', 'info');
                        }
                    });
            });
        }
        
        // Cargar vista unificada para admin
        function cargarVistaUnificadaAdmin(terminales) {
            const container = document.getElementById('vista-unificada-admin');
            const gridContainer = document.getElementById('grid-terminales-admin');
            
            if (!terminales || Object.keys(terminales).length === 0) {
                container.style.display = 'none';
                return;
            }
            
            let html = '';
            Object.entries(terminales).forEach(([terminal, stats]) => {
                html += `
                    <div class="card">
                        <div class="card-header" style="background: var(--naranja-claro); text-align: center; padding: 0.8rem;">
                            üè™ ${terminal}
                        </div>
                        <div class="card-body" style="padding: 1rem;">
                            <div style="text-align: center; margin-bottom: 0.8rem;">
                                <h3 style="color: var(--naranja-primario); font-size: 1.5rem; margin: 0 0 0.3rem 0;">
                                    ${stats.ventas_totales || '0'}
                                </h3>
                                <p style="color: var(--texto-gris); margin: 0; font-size: 0.8rem;">Ventas Totales</p>
                            </div>
                            <div style="background: var(--naranja-fondo); padding: 0.8rem; border-radius: 6px; font-size: 0.8rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                                    <span>Ingresos:</span>
                                    <strong>${stats.ingresos_totales || '$0.00'}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.4rem;">
                                    <span>Ventas Hoy:</span>
                                    <strong>${stats.ventas_hoy_count || '0'}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Productos Vendidos:</span>
                                    <strong>${stats.productos_vendidos_hoy || '0'}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            gridContainer.innerHTML = html;
            container.style.display = 'block';
        }
        
        // Cargar datos de ejemplo (fallback final)
        function cargarDatosEjemplo() {
            const esAdmin = usuarioActual.rol === 'admin';
            
            const datosEjemplo = {
                estadisticas: {
                    ventas_totales: esAdmin ? '150' : '25',
                    ingresos_totales: esAdmin ? '$375,000.00' : '$62,500.00',
                    productos_catalogo: '45',
                    monto_historico: esAdmin ? '$1,250,000.00' : '$312,500.00',
                    promedio_diario: esAdmin ? '$12,500.00/d√≠a' : '$4,166.67/d√≠a',
                    ventas_hoy_count: esAdmin ? '12' : '4',
                    ingresos_hoy: esAdmin ? '$30,000.00' : '$10,000.00',
                    productos_vendidos_hoy: esAdmin ? '28' : '9',
                    transacciones_hoy_count: esAdmin ? '12' : '4'
                },
                transacciones_hoy: [
                    {
                        Producto: 'Cajas Verdes GRANIA ANIMALES DINOS',
                        ID_Cliente: 'CLIENTE FG51-0301',
                        Fecha: '2025-11-25',
                        Hora: '12:40',
                        Total_Venta: 25000,
                        Cantidad: 1,
                        Terminal: 'POS1'
                    }
                ],
                productos_mas_vendidos: [
                    { producto: 'Cajas Verdes GRANIA ANIMALES DINOS', cantidad: 15, terminal: 'Varias' },
                    { producto: 'Producto Ejemplo 2', cantidad: 12, terminal: 'POS2' },
                    { producto: 'Producto Ejemplo 3', cantidad: 8, terminal: 'POS1' }
                ]
            };
            
            if (esAdmin) {
                datosEjemplo.terminales = {
                    POS1: { ventas_totales: '50', ingresos_totales: '$125,000.00', ventas_hoy_count: '4', productos_vendidos_hoy: '9' },
                    POS2: { ventas_totales: '55', ingresos_totales: '$137,500.00', ventas_hoy_count: '5', productos_vendidos_hoy: '11' },
                    POS3: { ventas_totales: '45', ingresos_totales: '$112,500.00', ventas_hoy_count: '3', productos_vendidos_hoy: '8' }
                };
            }
            
            actualizarDashboard(datosEjemplo.estadisticas);
            renderizarTransaccionesHoy(datosEjemplo.transacciones_hoy);
            renderizarProductosVendidos(datosEjemplo.productos_mas_vendidos);
            
            if (esAdmin && datosEjemplo.terminales) {
                cargarVistaUnificadaAdmin(datosEjemplo.terminales);
            }
        }
        
        // Actualizar dashboard con datos
        function actualizarDashboard(estadisticas) {
            // Ventas totales
            document.getElementById('ventas-totales').textContent = estadisticas.ventas_totales || '0';
            document.getElementById('ventas-hoy').textContent = `Hoy: ${estadisticas.ventas_hoy_count || '0'}`;
            
            // Ingresos
            document.getElementById('ingresos-totales').textContent = estadisticas.ingresos_totales || '$0.00';
            document.getElementById('ingresos-hoy').textContent = `Hoy: ${estadisticas.ingresos_hoy || '$0.00'}`;
            
            // Productos
            document.getElementById('productos-catalogo').textContent = estadisticas.productos_catalogo || '0';
            document.getElementById('productos-vendidos-hoy').textContent = `Vendidos hoy: ${estadisticas.productos_vendidos_hoy || '0'}`;
            
            // Monto hist√≥rico
            document.getElementById('monto-historico').textContent = estadisticas.monto_historico || '$0.00';
            document.getElementById('promedio-diario').textContent = `Promedio: ${estadisticas.promedio_diario || '$0.00'}/d√≠a`;
            
            // Transacciones
            document.getElementById('total-transacciones-hoy').textContent = `Hoy: ${estadisticas.transacciones_hoy_count || '0'}`;
            document.getElementById('transacciones-hoy-count').textContent = estadisticas.transacciones_hoy_count || '0';
        }
        
        // Renderizar transacciones
        function renderizarTransaccionesHoy(transacciones) {
            const container = document.getElementById('lista-transacciones-hoy');
            const esAdmin = usuarioActual.rol === 'admin';
            
            if (!transacciones || transacciones.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; color: var(--texto-gris);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
                        <p>No hay transacciones hoy</p>
                        <p style="font-size: 0.8rem;">Las ventas de hoy aparecer√°n aqu√≠</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            transacciones.forEach(transaccion => {
                const fecha = new Date(transaccion.Fecha + 'T' + transaccion.Hora);
                const horaFormateada = fecha.toLocaleTimeString('es-ES', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                html += `
                    <div style="border: 1px solid var(--naranja-borde); border-radius: 6px; padding: 0.8rem; margin-bottom: 0.6rem; background: white;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.4rem;">
                            <div style="flex: 1;">
                                <h4 style="color: var(--texto-oscuro); margin: 0 0 0.2rem 0; font-size: 0.9rem;">
                                    ${transaccion.Producto || 'Producto no disponible'}
                                    ${esAdmin ? `<span class="terminal-indicator">${transaccion.Terminal || 'N/A'}</span>` : ''}
                                </h4>
                                <div style="display: flex; gap: 0.8rem; font-size: 0.75rem; color: var(--texto-gris);">
                                    <span><strong>Cliente:</strong> ${transaccion.ID_Cliente || 'N/A'}</span>
                                    <span><strong>Hora:</strong> ${horaFormateada}</span>
                                </div>
                            </div>
                            <div style="text-align: right; min-width: 100px;">
                                <div style="font-size: 1rem; font-weight: bold; color: #28a745;">
                                    $${(transaccion.Total_Venta || 0).toFixed(2)}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--texto-gris);">
                                    Cant: ${transaccion.Cantidad || 0}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Renderizar productos vendidos
        function renderizarProductosVendidos(productos) {
            const container = document.getElementById('lista-productos-vendidos');
            const esAdmin = usuarioActual.rol === 'admin';
            
            if (!productos || productos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 1.5rem; color: var(--texto-gris);">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì¶</div>
                        <p>No hay productos vendidos hoy</p>
                        <p style="font-size: 0.8rem;">Los productos m√°s vendidos aparecer√°n aqu√≠</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; gap: 0.5rem;">';
            productos.forEach((producto, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ';
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: var(--naranja-fondo); border-radius: 8px;">
                        <div style="display: flex; align-items: center; gap: 0.8rem;">
                            <span style="font-size: 1.2rem;">${medal}</span>
                            <div>
                                <div style="font-size: 0.9rem; font-weight: 500;">${producto.producto || 'Producto no disponible'}</div>
                                <div style="font-size: 0.75rem; color: var(--texto-gris);">
                                    ${producto.cantidad || 0} unidades
                                    ${esAdmin ? `<div style="margin-top: 0.2rem;"><span class="terminal-indicator">${producto.terminal || 'Varias terminales'}</span></div>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.9rem; font-weight: bold; color: var(--naranja-primario);">
                                #${index + 1}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Descargar Excel
        function descargarExcel() {
            showNotification('üìä Generando archivo Excel...', 'info');
            
            const esAdmin = usuarioActual.rol === 'admin';
            const endpoint = esAdmin ? '/descargar-excel?terminal=TODAS' : `/descargar-excel?terminal=${usuarioActual.terminal}`;
            
            fetch(endpoint)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al generar el archivo');
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    
                    const fecha = new Date().toISOString().split('T')[0];
                    const nombreArchivo = esAdmin 
                        ? `ventas_pocopan_unificado_${fecha}.xlsx`
                        : `ventas_pocopan_${usuarioActual.terminal}_${fecha}.xlsx`;
                    
                    a.download = nombreArchivo;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    showNotification('‚úÖ Excel descargado correctamente', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('‚ùå Error al descargar el Excel', 'error');
                });
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            actualizarFechaHora();
            configurarInterfazPorRol();
            
            // Cargar datos iniciales
            cargarEstadisticasAvanzadas();
            
            // Actualizar cada 30 segundos
            setInterval(cargarEstadisticasAvanzadas, 30000);
        });
    </script>
</body>
</html>