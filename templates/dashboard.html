{% extends "base.html" %}

{% block title %}Dashboard - POCOPAN{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <div>
            <h1 style="color: var(--naranja-primario); margin-bottom: 0.3rem; font-size: 1.5rem;">{{ stats.dashboard_nombre }}</h1>
            <p style="color: var(--texto-gris); font-size: 0.9rem;">
                üìä Estad√≠sticas en tiempo real ‚Ä¢ 
                <span id="fecha-actual" style="font-weight: 600;"></span>
            </p>
        </div>
        <div class="user-terminal">
            Actualizado: {{ now.strftime('%H:%M') if now else 'Ahora' }}
        </div>
    </div>

    <!-- Selector de Terminal (solo admin) -->
    {% if rol_actual == 'admin' %}
    <div class="card mb-2">
        <div class="card-body" style="padding: 0.8rem;">
            <h3 style="margin-bottom: 0.8rem; color: var(--naranja-primario); font-size: 1rem;">üîç Seleccionar Terminal</h3>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <a href="{{ url_for('dashboard_terminal', terminal_id='TODAS') }}" 
                   class="btn {% if terminal_actual == 'TODAS' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 6px 12px; font-size: 0.8rem;">
                    üìä Todas las Terminales
                </a>
                <a href="{{ url_for('dashboard_terminal', terminal_id='POS1') }}" 
                   class="btn {% if terminal_actual == 'POS1' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 6px 12px; font-size: 0.8rem;">
                    üè™ POS 1
                </a>
                <a href="{{ url_for('dashboard_terminal', terminal_id='POS2') }}" 
                   class="btn {% if terminal_actual == 'POS2' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 6px 12px; font-size: 0.8rem;">
                    üè™ POS 2
                </a>
                <a href="{{ url_for('dashboard_terminal', terminal_id='POS3') }}" 
                   class="btn {% if terminal_actual == 'POS3' %}btn-primary{% else %}btn-outline{% endif %}" 
                   style="padding: 6px 12px; font-size: 0.8rem;">
                    üè™ POS 3
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Estad√≠sticas Principales -->
    <div class="grid grid-4 mb-2">
        <div class="card">
            <div class="card-header" style="background: var(--naranja-primario); padding: 0.8rem;">
                üè∑Ô∏è Ventas Totales
            </div>
            <div class="card-body" style="text-align: center; padding: 1rem 0.5rem;">
                <h2 style="font-size: 1.8rem; color: var(--naranja-primario); margin: 0; line-height: 1;">{{ stats.ventas_totales }}</h2>
                <p style="color: var(--texto-gris); margin: 0.3rem 0 0 0; font-size: 0.8rem;">Transacciones</p>
                <div style="margin-top: 0.5rem; padding: 0.4rem; background: var(--naranja-fondo); border-radius: 4px;">
                    <small style="color: var(--naranja-oscuro); font-size: 0.75rem;">Hoy: {{ stats.ventas_hoy_count }}</small>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="background: #28a745; padding: 0.8rem;">
                üí∞ Ingresos Totales
            </div>
            <div class="card-body" style="text-align: center; padding: 1rem 0.5rem;">
                <h2 style="font-size: 1.4rem; color: #28a745; margin: 0; line-height: 1.2;">{{ stats.ingresos_totales }}</h2>
                <p style="color: var(--texto-gris); margin: 0.3rem 0 0 0; font-size: 0.8rem;">Acumulado</p>
                <div style="margin-top: 0.5rem; padding: 0.4rem; background: #f0fff4; border-radius: 4px;">
                    <small style="color: #28a745; font-size: 0.75rem;" id="ingresos-hoy">Hoy: $0.00</small>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="background: #17a2b8; padding: 0.8rem;">
                üì¶ Productos
            </div>
            <div class="card-body" style="text-align: center; padding: 1rem 0.5rem;">
                <h2 style="font-size: 1.8rem; color: #17a2b8; margin: 0; line-height: 1;">{{ stats.productos_catalogo }}</h2>
                <p style="color: var(--texto-gris); margin: 0.3rem 0 0 0; font-size: 0.8rem;">En cat√°logo</p>
                <div style="margin-top: 0.5rem; padding: 0.4rem; background: #f0fdff; border-radius: 4px;">
                    <small style="color: #17a2b8; font-size: 0.75rem;" id="productos-vendidos-hoy">Vendidos hoy: 0</small>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header" style="background: #6f42c1; padding: 0.8rem;">
                üìà Monto Hist√≥rico
            </div>
            <div class="card-body" style="text-align: center; padding: 1rem 0.5rem;">
                <h2 style="font-size: 1.4rem; color: #6f42c1; margin: 0; line-height: 1.2;" id="monto-historico">$0.00</h2>
                <p style="color: var(--texto-gris); margin: 0.3rem 0 0 0; font-size: 0.8rem;">Total hist√≥rico</p>
                <div style="margin-top: 0.5rem; padding: 0.4rem; background: #f8f5ff; border-radius: 4px;">
                    <small style="color: #6f42c1; font-size: 0.75rem;" id="promedio-diario">Promedio: $0.00/d√≠a</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones R√°pidas -->
    <div class="card mb-2">
        <div class="card-header">
            üöÄ Acciones R√°pidas
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 0.8rem; flex-wrap: wrap;">
                <button onclick="descargarExcel()" class="btn btn-success">
                    üìä Descargar Excel de Ventas
                </button>
                <button onclick="cargarEstadisticasAvanzadas()" class="btn btn-outline">
                    üîÑ Actualizar Datos
                </button>
                {% if rol_actual == 'admin' %}
                <a href="{{ url_for('editor_catalogo') }}" class="btn btn-outline">
                    ‚úèÔ∏è Editor de Cat√°logo
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- √öltimas Transacciones del D√≠a -->
    <div class="card mb-2">
        <div class="card-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>üìã Transacciones de Hoy</span>
                <span class="user-terminal" id="total-transacciones-hoy">0 transacciones</span>
            </div>
        </div>
        <div class="card-body">
            <div id="lista-transacciones-hoy" class="scroll-container" style="max-height: 400px;">
                <div style="text-align: center; padding: 2rem; color: var(--texto-gris);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîÑ</div>
                    <p>Cargando transacciones del d√≠a...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos M√°s Vendidos (simplificado) -->
    <div class="card">
        <div class="card-header">
            üèÜ Productos M√°s Vendidos (Hoy)
        </div>
        <div class="card-body">
            <div id="lista-productos-vendidos">
                <div style="text-align: center; padding: 1rem; color: var(--texto-gris);">
                    <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üì¶</div>
                    <p>Cargando productos m√°s vendidos...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Comparaci√≥n de Terminales (solo admin) -->
    {% if rol_actual == 'admin' and stats_por_terminal %}
    <div class="card mt-2">
        <div class="card-header">
            üìà Comparaci√≥n entre Terminales
        </div>
        <div class="card-body">
            <div class="grid grid-3">
                {% for terminal, terminal_stats in stats_por_terminal.items() %}
                <div class="card">
                    <div class="card-header" style="background: var(--naranja-claro); padding: 0.8rem;">
                        üè™ {{ terminal }}
                    </div>
                    <div class="card-body" style="padding: 0.8rem;">
                        <div style="text-align: center; margin-bottom: 0.8rem;">
                            <h3 style="color: var(--naranja-primario); font-size: 1.2rem; margin: 0;">{{ terminal_stats.ventas_totales }}</h3>
                            <p style="color: var(--texto-gris); margin: 0.2rem 0 0 0; font-size: 0.75rem;">Ventas Totales</p>
                        </div>
                        <div style="background: var(--naranja-fondo); padding: 0.6rem; border-radius: 6px; font-size: 0.8rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <span>Ingresos:</span>
                                <strong>{{ terminal_stats.ingresos_totales }}</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Ventas Hoy:</span>
                                <strong>{{ terminal_stats.ventas_hoy_count }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Actualizar fecha actual
    document.getElementById('fecha-actual').textContent = new Date().toLocaleDateString('es-ES', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });

    // Cargar estad√≠sticas avanzadas
    function cargarEstadisticasAvanzadas() {
        fetch('/estadisticas-avanzadas?terminal={{ terminal_actual }}')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    actualizarDashboard(data.estadisticas);
                    renderizarTransaccionesHoy(data.transacciones_hoy);
                    renderizarProductosVendidos(data.productos_mas_vendidos);
                }
            })
            .catch(error => {
                console.error('Error cargando estad√≠sticas:', error);
            });
    }

    function actualizarDashboard(estadisticas) {
        // Actualizar ingresos de hoy
        document.getElementById('ingresos-hoy').textContent = `Hoy: $${estadisticas.ingresos_hoy.toFixed(2)}`;
        
        // Actualizar productos vendidos hoy
        document.getElementById('productos-vendidos-hoy').textContent = `Vendidos hoy: ${estadisticas.productos_vendidos_hoy}`;
        
        // Actualizar monto hist√≥rico
        document.getElementById('monto-historico').textContent = `$${estadisticas.monto_historico.toFixed(2)}`;
        document.getElementById('promedio-diario').textContent = `Promedio: $${estadisticas.promedio_diario.toFixed(2)}/d√≠a`;
        
        // Actualizar total de transacciones hoy
        document.getElementById('total-transacciones-hoy').textContent = `${estadisticas.transacciones_hoy_count} transacciones`;
    }

    function renderizarTransaccionesHoy(transacciones) {
        const container = document.getElementById('lista-transacciones-hoy');
        
        if (transacciones.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: var(--texto-gris);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
                    <p>No hay transacciones hoy</p>
                    <p style="font-size: 0.8rem;">Las ventas de hoy aparecer√°n aqu√≠</p>
                </div>
            `;
            return;
        }

        let html = '';
        transacciones.forEach(transaccion => {
            const fecha = new Date(transaccion.fecha + 'T' + transaccion.hora);
            const horaFormateada = fecha.toLocaleTimeString('es-ES', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            html += `
                <div style="border: 1px solid var(--naranja-borde); border-radius: 6px; padding: 0.8rem; margin-bottom: 0.6rem; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.4rem;">
                        <div style="flex: 1;">
                            <h4 style="color: var(--texto-oscuro); margin: 0 0 0.2rem 0; font-size: 0.9rem;">
                                ${transaccion.producto}
                            </h4>
                            <div style="display: flex; gap: 0.8rem; font-size: 0.75rem; color: var(--texto-gris);">
                                <span><strong>Cliente:</strong> ${transaccion.id_cliente}</span>
                                <span><strong>Terminal:</strong> ${transaccion.id_terminal}</span>
                                <span><strong>Hora:</strong> ${horaFormateada}</span>
                            </div>
                        </div>
                        <div style="text-align: right; min-width: 100px;">
                            <div style="font-size: 1rem; font-weight: bold; color: #28a745;">
                                $${transaccion.total_venta.toFixed(2)}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--texto-gris);">
                                Cant: ${transaccion.cantidad}
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.75rem;">
                        <div><strong>Precio Unit:</strong> $${transaccion.precio_unitario.toFixed(2)}</div>
                        <div><strong>Vendedor:</strong> ${transaccion.vendedor}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    function renderizarProductosVendidos(productos) {
        const container = document.getElementById('lista-productos-vendidos');
        
        if (productos.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 1rem; color: var(--texto-gris);">
                    <p>No hay productos vendidos hoy</p>
                </div>
            `;
            return;
        }

        let html = '<div style="display: grid; gap: 0.5rem;">';
        productos.forEach((producto, index) => {
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.6rem; background: var(--naranja-fondo); border-radius: 6px;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span style="background: var(--naranja-primario); color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem; font-weight: bold;">
                            ${index + 1}
                        </span>
                        <span style="font-size: 0.85rem; font-weight: 500;">${producto.producto}</span>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.9rem; font-weight: bold; color: var(--naranja-primario);">
                            ${producto.cantidad} unidades
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        
        container.innerHTML = html;
    }

    function descargarExcel() {
        showNotification('Generando archivo Excel...', 'info');
        
        fetch('/descargar-excel?terminal={{ terminal_actual }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al generar el archivo');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `ventas_pocopan_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                showNotification('‚úÖ Excel descargado correctamente', 'success');
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('‚ùå Error al descargar el Excel', 'error');
            });
    }

    // Cargar estad√≠sticas al iniciar
    document.addEventListener('DOMContentLoaded', function() {
        cargarEstadisticasAvanzadas();
        
        // Actualizar cada 30 segundos
        setInterval(cargarEstadisticasAvanzadas, 30000);
    });
</script>
{% endblock %}